import{c as N,u as z,r as w,q as R,w as M,b as C,o as D,d as I,e as T,j as e,D as B,f as O,g as L,h as P,B as U,i as H,m as E,S as Y,U as $,P as K,L as G}from"./index-SgyLPKfI.js";import{T as F}from"./trash-2-COGSar9e.js";import{C as W}from"./circle-check-CRcxlp_E.js";const q=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],V=N("message-square",q);const X=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],J=N("send",X),_=new Map,Q=6e4,Z=10;function ee(r){const o=Date.now(),m=(_.get(r)||[]).filter(g=>o-g<Q);return m.length>=Z?!1:(m.push(o),_.set(r,m),!0)}function te(r){let o=r.trim().slice(0,1e3);return o=o.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),o}function re(r){return{pendingTasks:(r.pendingTasks||[]).slice(0,20).map(c=>({title:String(c.title||"").slice(0,100),priority:String(c.priority||"medium"),horizon:String(c.horizon||"daily"),isRolledOver:!!c.isRolledOver})),yesterdayCompletedCount:Number(r.yesterdayCompletedCount)||0,streak:Number(r.streak)||0}}const se=async(r,o,c)=>{const m="AIzaSyAKKtxXnPD1sEKec-TC9XT0ww47SryLQlA";if(c&&!ee(c))throw new Error("You're sending messages too fast. Please wait a moment before trying again.");const g=te(r);if(!g)throw new Error("Message cannot be empty.");const S=re(o),f=`
      You are an elite productivity battle coach inside a mission management app (Attackers Arena).
      Your role is to help users plan their day intelligently.
      
      Current User Context:
      - Pending Tasks (Title, Priority, Horizon, RolledOver): ${JSON.stringify(S.pendingTasks)}
      - Yesterday's Completed Tasks: ${S.yesterdayCompletedCount}
      - Current Streak: ${S.streak} days
      
      User Message: "${g}"
      
      Response Guidelines:
      1. Suggest realistic tasks (3-6 max) based on capacity.
      2. Prioritize EXISTING pending tasks first, especially if skipped yesterday (isRolledOver=true).
      3. Only suggest new tasks if the plan needs filling.
      4. Break large goals into smaller steps if they seem stuck.
      5. Tone: Encouraging, structured, professional but friendly. Use short sentences.
      6. Output strict JSON.

      JSON Schema:
      {
        "reflection": "Brief analysis of their workload or situation.",
        "suggestedTasks": [
          {
            "title": "Task Title",
            "priority": "critical | high | medium | low",
            "estimatedTime": "number (minutes)",
            "reason": "Why this task?"
          }
        ],
        "focusAdvice": "One sentence of actionable advice."
      }
    `;try{const y=new AbortController,k=setTimeout(()=>y.abort(),3e4),u=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${m}`,{method:"POST",headers:{"Content-Type":"application/json"},signal:y.signal,body:JSON.stringify({contents:[{parts:[{text:f}]}],generationConfig:{responseMimeType:"application/json",temperature:.7},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]})});if(clearTimeout(k),!u.ok)throw await u.json().catch(()=>({})),u.status===403||u.status===401?new Error("AI service authentication failed. Please contact support."):u.status===429?new Error("AI service is busy. Please try again in a moment."):new Error(`AI service error (${u.status}). Please try again.`);const p=(await u.json()).candidates?.[0]?.content?.parts?.[0]?.text;if(!p)throw new Error("Empty response from AI. Please try again.");try{let d=p.trim();d=d.replace(/```json/g,"").replace(/```/g,"");const x=d.indexOf("{"),j=d.lastIndexOf("}");x!==-1&&j!==-1&&(d=d.substring(x,j+1));const h=JSON.parse(d);return{reflection:String(h.reflection||"Here's my analysis.").slice(0,500),suggestedTasks:Array.isArray(h.suggestedTasks)?h.suggestedTasks.slice(0,6).map(b=>({title:String(b.title||"Untitled").slice(0,100),priority:["critical","high","medium","low"].includes(b.priority)?b.priority:"medium",estimatedTime:Math.min(Math.max(Number(b.estimatedTime)||30,5),480),reason:String(b.reason||"").slice(0,200)})):[],focusAdvice:String(h.focusAdvice||"Stay focused and take one step at a time.").slice(0,300)}}catch{return{reflection:"I'm having trouble formatting my response, but here are my thoughts.",suggestedTasks:[],focusAdvice:p.substring(0,150)+"..."}}}catch(y){throw y.name==="AbortError"?new Error("Request timed out. Please try again."):y}};function oe(){const{user:r,tasks:o,addTask:c,getStreak:m,pendingAssistantMessage:g,setPendingAssistantMessage:S}=z(),[f,y]=w.useState(""),[k,u]=w.useState([]),[A,p]=w.useState(!1),[d,x]=w.useState(null),j=w.useRef(null);w.useEffect(()=>{g&&!A&&(h(g),S(void 0))},[g]),w.useEffect(()=>{if(!r)return;const t=R(C(T,"ai_chats"),M("userId","==",r.uid)),a=D(t,i=>{const s=i.docs.map(n=>({id:n.id,...n.data()}));s.sort((n,v)=>new Date(n.createdAt).getTime()-new Date(v.createdAt).getTime()),u(s),setTimeout(()=>j.current?.scrollIntoView({behavior:"smooth"}),100)},i=>{console.error("Firestore Snapshot Error:",i),x("Failed to load history: "+i.message)});return()=>a()},[r]);const h=async t=>{const a=typeof t=="string"?t:f;if(!a.trim()||!r)return;const i=a.trim().slice(0,1e3);if(!(i.length<2)){y(""),p(!0),x(null);try{try{await I(C(T,"ai_chats"),{userId:r.uid,role:"user",content:i,createdAt:new Date().toISOString()})}catch(l){throw console.error("Firestore Error (User Message):",l),new Error("Could not send message. Check internet connection.")}const n={pendingTasks:o.filter(l=>!l.isCompleted).map(l=>({title:l.title,priority:l.priority,horizon:l.horizon,isRolledOver:l.isRolledOver})),yesterdayCompletedCount:0,streak:m()};let v;try{v=await se(i,n,r.uid)}catch(l){throw new Error(l.message||"AI is temporarily unavailable. Please try again.")}if(!v)throw new Error("No response from AI");try{await I(C(T,"ai_chats"),{userId:r.uid,role:"assistant",content:v.reflection+`

`+v.focusAdvice,suggestedTasks:v.suggestedTasks,createdAt:new Date().toISOString()})}catch(l){throw console.error("Firestore Error (AI Message):",l),new Error("Failed to save AI response.")}}catch(s){x(s.message||"An error occurred");try{await I(C(T,"ai_chats"),{userId:r.uid,role:"assistant",content:`Error: ${s.message||"Something went wrong."}`,createdAt:new Date().toISOString()})}catch{}}finally{p(!1)}}},b=t=>{c({title:t.title,description:"AI Suggested Task",priority:t.priority?.toLowerCase()||"medium",horizon:"daily",category:"Work",dueDate:O(new Date,"yyyy-MM-dd"),energyLevel:"medium",estimatedMinutes:parseInt(t.estimatedTime)||30,subtasks:[],tags:["AI Suggested"],recurrence:"none"})};return e.jsxs("div",{className:"page-content",style:{display:"flex",flexDirection:"column",height:"calc(100vh - 80px)",maxWidth:900,margin:"0 auto"},children:[e.jsxs("div",{className:"chat-header",style:{marginBottom:20,textAlign:"center",position:"relative"},children:[e.jsxs("div",{style:{position:"absolute",right:0,top:0,display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>{if(k.length===0)return;const t=k.map(n=>`${n.role==="user"?"You":"Coach"}: ${n.content}`).join(`

`),a=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=`coach-aries-history-${O(new Date,"yyyy-MM-dd")}.txt`,s.click()},className:"btn-icon",title:"Export Chat",style:{background:"rgba(255,255,255,0.05)",border:"none",color:"var(--text-tertiary)",cursor:"pointer",padding:8,borderRadius:8},children:e.jsx(B,{size:18})}),e.jsx("button",{onClick:async()=>{if(window.confirm("Are you sure you want to clear your chat history? This cannot be undone.")){p(!0);try{const t=R(C(T,"ai_chats"),M("userId","==",r?.uid)),a=await L(t),i=P(T);a.docs.forEach(s=>i.delete(s.ref)),await i.commit()}catch(t){console.error("Error clearing history:",t),x("Failed to clear history.")}finally{p(!1)}}},className:"btn-icon",title:"Clear History",style:{background:"rgba(255,255,255,0.05)",border:"none",color:"var(--text-tertiary)",cursor:"pointer",padding:8,borderRadius:8},children:e.jsx(F,{size:18})})]}),e.jsx("div",{style:{display:"inline-flex",padding:12,background:"rgba(124, 108, 240, 0.1)",borderRadius:16,marginBottom:12},children:e.jsx(U,{size:32,color:"var(--accent-primary)"})}),e.jsx("h1",{children:"AI Productivity Coach"}),e.jsx("p",{style:{color:"var(--text-tertiary)"},children:"Tell me about your day, and I'll help you plan it perfectly."})]}),e.jsxs("div",{className:"chat-container",style:{flex:1,overflowY:"auto",padding:"0 10px",display:"flex",flexDirection:"column",gap:20},children:[d&&e.jsxs("div",{style:{background:"rgba(255, 82, 82, 0.1)",border:"1px solid var(--accent-danger)",color:"var(--accent-danger)",padding:12,borderRadius:12,fontSize:13,display:"flex",alignItems:"center",gap:8},children:[e.jsx(H,{size:16}),d]}),k.length===0&&e.jsxs("div",{style:{textAlign:"center",color:"var(--text-tertiary)",marginTop:40},children:[e.jsx(V,{size:48,style:{opacity:.2,marginBottom:16}}),e.jsx("p",{children:'No messages yet. Start by saying "Help me plan my day!"'})]}),k.map(t=>e.jsxs(E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`message ${t.role}`,style:{alignSelf:t.role==="user"?"flex-end":"flex-start",maxWidth:"85%",background:t.role==="user"?"var(--accent-primary)":"var(--bg-card)",color:t.role==="user"?"white":"var(--text-primary)",padding:16,borderRadius:16,borderBottomRightRadius:t.role==="user"?4:16,borderBottomLeftRadius:t.role==="assistant"?4:16,boxShadow:"0 2px 8px rgba(0,0,0,0.1)",border:t.role==="assistant"?"1px solid var(--border-subtle)":"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4,opacity:.7,fontSize:12},children:[t.role==="assistant"?e.jsx(Y,{size:12}):e.jsx($,{size:12}),e.jsx("span",{children:t.role==="assistant"?"Coach":"You"})]}),e.jsx("div",{style:{whiteSpace:"pre-wrap",lineHeight:1.5},children:t.content}),t.suggestedTasks&&t.suggestedTasks.length>0&&e.jsxs("div",{style:{marginTop:16,background:"rgba(0,0,0,0.2)",padding:12,borderRadius:12},children:[e.jsx("div",{style:{fontSize:13,fontWeight:600,marginBottom:8,color:"var(--accent-primary)"},children:"SUGGESTED TASKS"}),t.suggestedTasks.map((a,i)=>{const s=o.find(n=>n.title.toLowerCase()===a.title.toLowerCase()&&!n.isCompleted);return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.05)"},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:500,display:"flex",alignItems:"center",gap:6},children:[a.title,s&&e.jsx("span",{style:{fontSize:10,background:"rgba(255,255,255,0.1)",padding:"2px 6px",borderRadius:4,opacity:.7},children:"Active"})]}),e.jsxs("div",{style:{fontSize:12,opacity:.7},children:[a.priority," • ",a.estimatedTime,"m • ",a.reason]})]}),!s&&e.jsx("button",{onClick:()=>b(a),className:"btn-icon",style:{background:"var(--accent-success)",color:"white",width:28,height:28,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"none",cursor:"pointer"},title:"Add to My Tasks",children:e.jsx(K,{size:16})}),s&&e.jsx("div",{style:{width:28,height:28,display:"flex",alignItems:"center",justifyContent:"center",opacity:.5},children:e.jsx(W,{size:16})})]},i)})]})]},t.id)),A&&e.jsx(E.div,{initial:{opacity:0},animate:{opacity:1},style:{alignSelf:"flex-start",background:"var(--bg-card)",padding:16,borderRadius:16,borderBottomLeftRadius:4},children:e.jsxs("div",{style:{display:"flex",gap:6},children:[e.jsx(E.div,{animate:{y:[0,-5,0]},transition:{repeat:1/0,duration:.6,delay:0},style:{width:6,height:6,background:"var(--text-tertiary)",borderRadius:"50%"}}),e.jsx(E.div,{animate:{y:[0,-5,0]},transition:{repeat:1/0,duration:.6,delay:.1},style:{width:6,height:6,background:"var(--text-tertiary)",borderRadius:"50%"}}),e.jsx(E.div,{animate:{y:[0,-5,0]},transition:{repeat:1/0,duration:.6,delay:.2},style:{width:6,height:6,background:"var(--text-tertiary)",borderRadius:"50%"}})]})}),e.jsx("div",{ref:j})]}),e.jsxs("div",{className:"chat-input",style:{marginTop:20},children:[e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{type:"text",value:f,onChange:t=>y(t.target.value.slice(0,1e3)),onKeyDown:t=>t.key==="Enter"&&h(),placeholder:"Ask for a plan, or just vent about your workload...",maxLength:1e3,style:{width:"100%",padding:"16px 50px 16px 20px",background:"var(--bg-card)",border:"1px solid var(--border-subtle)",borderRadius:24,color:"var(--text-primary)",fontSize:16,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},disabled:A}),e.jsx("button",{onClick:()=>h(),disabled:A||!f.trim(),style:{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",width:36,height:36,borderRadius:"50%",background:f.trim()?"var(--accent-primary)":"var(--bg-secondary)",color:"white",border:"none",cursor:f.trim()?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s"},children:A?e.jsx(G,{size:18,className:"spin"}):e.jsx(J,{size:18})})]}),e.jsx("div",{style:{textAlign:"center",fontSize:12,color:"var(--text-tertiary)",marginTop:8},children:"AI can make mistakes. Please verify important info."})]})]})}export{oe as default};
