rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // ðŸ” AUTH HELPERS
    // ==============================

    function isAuth() {
      return request.auth != null && request.auth.uid != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function hasRequiredFields(requiredFields) {
      return request.resource.data.keys().hasAll(requiredFields);
    }

    // Validate task/template structure (prevent injection)
    function isValidTask(task) {
      return task.title is string
        && task.title.size() > 0
        && task.title.size() <= 200
        && task.priority in ['low', 'medium', 'high', 'critical']
        && task.horizon in ['daily', 'monthly', 'yearly']
        && task.userId is string;
    }

    // Validate instance structure
    function isValidInstance(instance) {
      return instance.taskId is string
        && instance.userId is string
        && instance.date.matches('\\d{4}-\\d{2}-\\d{2}')
        && instance.status in ['pending', 'completed', 'missed'];
    }

    // ==============================
    // ðŸ‘¤ USERS COLLECTION
    // ==============================
    // Structure: /users/{uid}
    // Contains: profile data, tasks array, instances array, etc.
    // NOTE: Data stored as arrays because normalized structure 
    //       would require major refactor. Consider migration for scale.

    match /users/{userId} {
      
      // Create (first signup) - DISABLED per request to remove sign up feature
      allow create: if false;

      // Read (own profile only)
      allow read: if isOwner(userId);

      // Update (only own data, cannot change uid/email)
      allow update: if isOwner(userId)
        && request.resource.data.uid == userId
        && request.resource.data.email == resource.data.email  // Email immutable
        && request.resource.data.createdAt == resource.data.createdAt  // CreatedAt immutable
        // Validate arrays contain only own data with strict limits
        && (request.resource.data.tasks == null || 
            request.resource.data.tasks.size() <= 150)  // Max 150 task templates per user (reasonable)
        && (request.resource.data.instances == null || 
            request.resource.data.instances.size() <= 1000)  // Max 1000 instances (daily=365+30+1=396, 2yr max)
        && (request.resource.data.profile == null || 
            request.resource.data.profile.level <= 999)  // Prevent level overflow
        && (request.resource.data.profile == null || 
            request.resource.data.profile.xp >= 0)  // XP cannot be negative
        && (request.resource.data.completionHistory == null || 
            request.resource.data.completionHistory.size() <= 3650);  // Max 10 years of history

      // Delete (prevent account deletion)
      allow delete: if false;

      // -------- TASKS Array Validation --------
      // Validates that all tasks in array belong to user
      // Added as inline validation because tasks stored as array

      // -------- INSTANCES Array Validation --------
      // Validates that all instances in array belong to user

      // -------- JOURNAL ENTRIES Array Validation --------
      // Validates that all entries in array belong to user
    }

    // ==============================
    // ðŸ¤– AI CONVERSATIONS COLLECTION
    // ==============================
    // Structure: /ai_conversations/{conversationId}
    // - userId: who owns this conversation
    // - createdAt: when created
    // - lastMessageAt: for sorting
    // - title: optional conversation title
    // Strict rules: Only user can access their conversations

    match /ai_conversations/{conversationId} {
      
      // Create new conversation
      allow create: if isAuth() 
        && request.resource.data.userId == request.auth.uid;

      // Read own conversations
      allow read: if isAuth() 
        && resource.data.userId == request.auth.uid;

      // Update own conversation
      allow update: if isAuth() 
        && resource.data.userId == request.auth.uid;

      // Delete own conversation
      allow delete: if isAuth() 
        && resource.data.userId == request.auth.uid;

      match /messages/{messageId} {
        
        // Create message in own conversation
        allow create: if isAuth()
          && request.resource.data.userId == request.auth.uid;

        // Read messages
        allow read: if isAuth()
          && resource.data.userId == request.auth.uid;

        allow update, delete: if false;
      }
    }

    // ==============================
    // ðŸ“” JOURNAL ENTRIES COLLECTION
    // ==============================
    // Structure: /journal_entries/{userId}_{date}
    // Enforces one entry per user per date
    // ACTIVE RULES - NOT COMMENTED OUT

    match /journal_entries/{entryId} {
      
      // Create journal entry
      allow create: if isAuth()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.date.matches('\\d{4}-\\d{2}-\\d{2}')
        && request.resource.data.content.size() > 0
        && request.resource.data.content.size() < 10000
        && hasRequiredFields(['userId', 'date', 'content', 'createdAt']);

      // Read own entries only
      allow read: if isAuth()
        && resource.data.userId == request.auth.uid;

      // Update own entries
      allow update: if isAuth()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.date == resource.data.date  // Date immutable
        && request.resource.data.createdAt == resource.data.createdAt  // CreatedAt immutable
        && request.resource.data.content.size() <= 10000;

      // Delete own entries
      allow delete: if false;
    }

    // ==============================
    // ðŸš« DEFAULT DENY
    // ==============================
    // Any path not explicitly allowed is DENIED

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
